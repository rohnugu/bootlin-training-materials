\section{Runtime Package Management}

\begin{frame}
  \frametitle{Introduction}
  \begin{itemize}
    \item BitBake always builds packages selected in
      \yoctovar{IMAGE_INSTALL}.
    \item The packages are used to generate the root filesystem.
    \item It is also possible to update the system at runtime using these
      packages, for many use cases:
      \begin{itemize}
        \item In-field security updates.
        \item System updates over the wire.
        \item System, packages or configuration customization at
          runtime.
        \item Remote debugging.
      \end{itemize}
    \item Using the Runtime Package Management is an optional feature.
    \item We'll use the IPK package format as an example in the
      following slides.
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Requirements}
  \begin{itemize}
    \item First of all, you need a server to serve the packages to a
      private subnet or over the Internet. Packages are typically
      served over \code{https} or \code{http}.
    \item Specific tools are also required on the target, and must be
      shipped on the product. They should be included into the images
      generated by the build system.
    \item These tools will be specific to the package type used.
      \begin{itemize}
        \item This is similar to Linux distributions: Debian is using
          \code{.deb} related tools (dpkg, apt\dots) while Fedora uses
          \code{.rpm} related ones (rpm, dnf).
      \end{itemize}
  \end{itemize}
\end{frame}

\subsection{Build configuration}

\begin{frame}
  \frametitle{Build configuration 1/2}
  \begin{itemize}
    \item The \yoctovar{PACKAGE_CLASSES} variable controls which package
      format to use. More than one can be used.
    \item Valid values are \code{package_rpm}, \code{package_deb},
      \code{package_ipk}.
    \item By default Poky uses the RPM format, while OpenEmbedded-Core
      uses the IPK one.
    \item Example:
      \begin{itemize}
        \item \code{PACKAGE_CLASSES = "package_ipk"}
        \item \code{PACKAGE_CLASSES = "package_rpm package_deb"}
      \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Build configuration 2/2}
  To install the required tools on the target, there are two
  possible solutions:
  \begin{itemize}
    \item By adding \code{package-management} to the images
      features.
      \begin{itemize}
        \item The required tool will be installed on the target.
        \item The package database corresponding to the build will be
          installed as well.
      \end{itemize}
    \item Or by manually adding the required tools in
      \yoctovar{IMAGE_INSTALL}. For example, to use the IPK format we
      need \code{opkg}.
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{Build considerations}
  \begin{itemize}
    \item The Runtime Package Management uses package databases to
      store information about available packages and their version.
    \item Whenever a build generates a new package or modifies an
      existing one, the package database must be updated.
    \item \code{$ bitbake package-index}
    \item Be careful: BitBake does not properly schedule the
      \code{package-index} target. You must use this target alone to
      have a consistent package database.
      \begin{itemize}
        \item \code{$ bitbake ninvaders package-index} won't
          necessarily generate an updated package database.
      \end{itemize}
  \end{itemize}
\end{frame}

\subsection{Package server configuration}

\begin{frame}[fragile]
  \frametitle{Apache2 example setup}
  Apache2 HTTP setup for IPK packages. This should go in
  \code{/etc/apache2/sites-enabled/package-server.conf}.
  \begin{block}{}
    \begin{minted}[fontsize=\small]{sh}
<VirtualHost *:80>
    ServerName packages.example.net

    DocumentRoot /path/to/build/tmp/deploy/ipk
    <Directory /path/to/build/tmp/deploy/ipk>
        Options +Indexes
        Options Indexes FollowSymLinks
        Order allow,deny
        allow from all
        AllowOverride None
        Require all granted
    </Directory>
</VirtualHost>
    \end{minted}
  \end{block}
\end{frame}

\subsection{Target configuration}

\begin{frame}[fragile]
  \frametitle{The IPK runtime management software}
  \begin{itemize}
    \item The IPK runtime management software is \code{opkg}.
    \item It can be configured using configurations files ending in
      \code{.conf} in \code{/etc/opkg/}.
    \item This configuration helps \code{opkg} to find the package
      databases you want to use.
    \item For example, with our previously configured package server:
    \begin{block}{}
      \begin{minted}{sh}
src/gz all http://packages.example.net/all
src/gz armv7a http://packages.example.net/armv7a
src/gz beaglebone http://packages.example.net/beaglebone
      \end{minted}
    \end{block}
    \item This can be automatically generated by defining the
      \yoctovar{PACKAGE_FEED_URIS}, \yoctovar{PACKAGE_FEED_BASE_PATHS}
      and \yoctovar{PACKAGE_FEED_ARCHS} variables
  \end{itemize}
\end{frame}

\begin{frame}
  \frametitle{\code{opkg} usage}
  \begin{itemize}
    \item \code{opkg update}: fetch and update the package
      databases, from the remote package servers.
    \item \code{opkg list}: list available packages.
    \item \code{opkg upgrade}: upgrade all installed packages.
    \item \code{opkg upgrade <package>}: upgrade one package
      explicitly.
    \item \code{opkg install <package>}: install a specific package.
  \end{itemize}
\end{frame}

\begin{frame}[fragile]
  \frametitle{\code{opkg} upgrade over an unstable network}
  \begin{itemize}
    \item To avoid upgrade issues when downloading packages from a
      remote package server using an unstable connection, you can
      first download the packages and then proceed with the upgrade.
    \item To do this we must use a cache, which can be defined in the
      \code{opkg} configuration with:
      \code{option cache /tmp/opkg-cache}.
  \end{itemize}
  \begin{block}{}
    \begin{minted}{console}
# opkg update
# opkg --download-only upgrade
# opkg upgrade
    \end{minted}
  \end{block}
\end{frame}
